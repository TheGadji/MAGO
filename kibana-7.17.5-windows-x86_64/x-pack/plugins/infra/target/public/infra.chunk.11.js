/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.infra_bundle_jsonpfunction=window.infra_bundle_jsonpfunction||[]).push([[11],{117:function(e,t,a){"use strict";a.d(t,"a",(function(){return i}));var r=a(3),n=a(67);function i(){const[e]=Object(r.useUiSetting$)(n.UI_SETTINGS.DATEFORMAT_TZ);return e&&"Browser"!==e?e:"local"}},131:function(e,t,a){"use strict";a.d(t,"i",(function(){return p})),a.d(t,"d",(function(){return g})),a.d(t,"f",(function(){return f})),a.d(t,"j",(function(){return b})),a.d(t,"k",(function(){return h})),a.d(t,"h",(function(){return y})),a.d(t,"g",(function(){return E})),a.d(t,"a",(function(){return v})),a.d(t,"e",(function(){return O})),a.d(t,"c",(function(){return T})),a.d(t,"b",(function(){return j}));var r=a(2),n=a.n(r),i=a(65),l=a(28),o=a(63),s=a.n(o),c=a(1),u=a(12),d=a(17),m=a(11);const p={headerFormatter:e=>s()(e.value).format("Y-MM-DD HH:mm:ss")},g=20,f={s:c.i18n.translate("xpack.infra.alerts.timeLabels.seconds",{defaultMessage:"seconds"}),m:c.i18n.translate("xpack.infra.alerts.timeLabels.minutes",{defaultMessage:"minutes"}),h:c.i18n.translate("xpack.infra.alerts.timeLabels.hours",{defaultMessage:"hours"}),d:c.i18n.translate("xpack.infra.alerts.timeLabels.days",{defaultMessage:"days"})},b=(e,t)=>Object(r.useMemo)((()=>"number"==typeof e&&"number"==typeof t?Object(i.niceTimeFormatter)([e,t]):e=>`${e}`),[e,t]),h=m.a,y=(e,t=!1)=>{let a=null,r=null;const n=e.reduce(((e,t)=>(t.points.forEach((t=>{const a=e[t.timestamp]||[];e[t.timestamp]=[...a,t.value]})),e)),{});Object.values(n).forEach((e=>{const n=t?Object(l.sum)(e):Object(l.max)(e),i=Object(l.min)(e);n&&(!r||n>r)&&(r=n),i&&(!a||i<a)&&(a=i)}));const i=Object.keys(n).map(Number),o=Object(l.min)(i)||0,s=Object(l.max)(i)||0;return{yMin:a||0,yMax:r||0,xMin:o,xMax:s}},E=e=>e?i.DARK_THEME:i.LIGHT_THEME,x=({children:e})=>n.a.createElement("div",{style:{width:"100%",height:150,display:"flex",justifyContent:"center",alignItems:"center"}},e),v=({children:e})=>n.a.createElement("div",{style:{width:"100%",height:150}},e),O=()=>n.a.createElement(x,null,n.a.createElement(u.EuiText,{color:"subdued","data-test-subj":"noChartData"},n.a.createElement(d.FormattedMessage,{id:"xpack.infra.alerts.charts.noDataMessage",defaultMessage:"No chart data available"}))),T=()=>n.a.createElement(x,null,n.a.createElement(u.EuiText,{color:"subdued","data-test-subj":"loadingData"},n.a.createElement(d.FormattedMessage,{id:"xpack.infra.alerts.charts.loadingMessage",defaultMessage:"Loading"}))),j=()=>n.a.createElement(x,null,n.a.createElement(u.EuiText,{color:"subdued","data-test-subj":"chartErrorState"},n.a.createElement(d.FormattedMessage,{id:"xpack.infra.alerts.charts.errorMessage",defaultMessage:"Uh oh, something went wrong"})))},175:function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var r=a(12),n=a(1),i=a(2),l=a.n(i);const o=({options:e,onChange:t,fields:a,errorOptions:o})=>{const s=Object(i.useCallback)((e=>{const a=e.map((e=>e.label));t(a)}),[t]),c=Array.isArray(e.groupBy)?e.groupBy.map((e=>({label:e,color:null!=o&&o.includes(e)?"danger":void 0}))):e.groupBy?[{label:e.groupBy,color:null!=o&&o.includes(e.groupBy)?"danger":void 0}]:[];return l.a.createElement(r.EuiComboBox,{"data-test-subj":"metricsExplorer-groupBy",placeholder:n.i18n.translate("xpack.infra.metricsExplorer.groupByLabel",{defaultMessage:"Everything"}),"aria-label":n.i18n.translate("xpack.infra.metricsExplorer.groupByAriaLabel",{defaultMessage:"Graph per"}),fullWidth:!0,singleSelection:!1,selectedOptions:c,options:a.filter((e=>e.aggregatable&&"string"===e.type)).map((e=>({label:e.name}))),onChange:s,isClearable:!0})}},176:function(e,t,a){"use strict";a.d(t,"a",(function(){return m}));var r=a(8),n=a.n(r),i=a(28),l=a(2),o=a(98),s=a(112),c=a(3),u=a(18),d=a(84);function m(e,t,a,r,m,p,g=!0){var f;const b=null===(f=Object(c.useKibana)().services.http)||void 0===f?void 0:f.fetch,[h,y]=Object(l.useState)(null),[E,x]=Object(l.useState)(!0),[v,O]=Object(l.useState)(null),[T,j]=Object(l.useState)(null),[k,M]=Object(l.useState)(null),F=n.a.parse(r.from),C=n.a.parse(r.to,{roundUp:!0}),[,w]=Object(d.c)({cancelPreviousOn:"creation",createPromise:()=>(x(!0),F&&C?b?t?b?b("/api/infra/metrics_explorer",{method:"POST",body:JSON.stringify({forceInterval:e.forceInterval,dropLastBucket:null==e.dropLastBucket||e.dropLastBucket,metrics:"count"===e.aggregation?[{aggregation:"count"}]:e.metrics.map((e=>({aggregation:e.aggregation,field:e.field}))),groupBy:e.groupBy,afterKey:m,limit:e.limit,indexPattern:t.metricAlias,filterQuery:e.filterQuery&&Object(s.a)(e.filterQuery,a)||void 0,timerange:{...r,field:t.fields.timestamp,from:F.valueOf(),to:C.valueOf()}})}):Promise.reject(new Error("HTTP service is unavailable")):Promise.reject(new Error("Source is unavailable")):Promise.reject(new Error("HTTP service is unavailable")):Promise.reject(new Error("Unalble to parse timerange"))),onResolve:t=>{x(!1);const a=Object(u.b)(o.e)(t);if(a){if(v&&T&&v.pageInfo.afterKey!==a.pageInfo.afterKey&&(n=T,l=e,Object(i.isEqual)(n,l))&&Object(i.isEqual)(r,k)&&m){const{series:e}=v;O({...a,series:[...e,...a.series]})}else O(a);j(e),M(r),y(null)}var n,l},onReject:e=>{y(e),x(!1)}},[t,r,e,p,m]);return Object(l.useEffect)((()=>{g&&w()}),[w,g]),{error:h,loading:E,data:v,loadData:w}}},177:function(e,t,a){"use strict";a.d(t,"a",(function(){return u}));var r=a(2),n=a.n(r),i=a(28),l=a(65),o=a(23),s=a(89);const c=.3,u=({threshold:e,sortedThresholds:t,comparator:a,color:r,id:u,firstTimestamp:d,lastTimestamp:m,domain:p})=>{if(!a||!e)return null;const g=[o.a.GT,o.a.GT_OR_EQ].includes(a),f=[o.a.LT,o.a.LT_OR_EQ].includes(a);return n.a.createElement(n.a.Fragment,null,n.a.createElement(l.LineAnnotation,{id:`${u}-thresholds`,domainType:l.AnnotationDomainType.YDomain,"data-test-subj":"threshold-line",dataValues:t.map((e=>({dataValue:e}))),style:{line:{strokeWidth:2,stroke:Object(s.b)(r),opacity:1}}}),2===t.length&&a===o.a.BETWEEN?n.a.createElement(n.a.Fragment,null,n.a.createElement(l.RectAnnotation,{id:`${u}-lower-threshold`,"data-test-subj":"between-rect",style:{fill:Object(s.b)(r),opacity:c},dataValues:[{coordinates:{x0:d,x1:m,y0:Object(i.first)(e),y1:Object(i.last)(e)}}]})):null,2===t.length&&a===o.a.OUTSIDE_RANGE?n.a.createElement(n.a.Fragment,null,n.a.createElement(l.RectAnnotation,{id:`${u}-lower-threshold`,"data-test-subj":"outside-range-lower-rect",style:{fill:Object(s.b)(r),opacity:c},dataValues:[{coordinates:{x0:d,x1:m,y0:p.min,y1:Object(i.first)(e)}}]}),n.a.createElement(l.RectAnnotation,{id:`${u}-upper-threshold`,"data-test-subj":"outside-range-upper-rect",style:{fill:Object(s.b)(r),opacity:c},dataValues:[{coordinates:{x0:d,x1:m,y0:Object(i.last)(e),y1:p.max}}]})):null,f&&null!=Object(i.first)(e)?n.a.createElement(l.RectAnnotation,{id:`${u}-upper-threshold`,"data-test-subj":"below-rect",style:{fill:Object(s.b)(r),opacity:c},dataValues:[{coordinates:{x0:d,x1:m,y0:p.min,y1:Object(i.first)(e)}}]}):null,g&&null!=Object(i.first)(e)?n.a.createElement(l.RectAnnotation,{id:`${u}-upper-threshold`,"data-test-subj":"above-rect",style:{fill:Object(s.b)(r),opacity:c},dataValues:[{coordinates:{x0:d,x1:m,y0:Object(i.first)(e),y1:p.max}}]}):null)}},296:function(e,t,a){"use strict";a.r(t),a.d(t,"defaultExpression",(function(){return D})),a.d(t,"Expressions",(function(){return N}));var r=a(28),n=a(2),i=a.n(n),l=a(12),o=a(17),s=a(1),c=a(24),u=a(70),d=a(149),m=a(175),p=a(132),g=a(112);const f=(e,t)=>{const a=t?new RegExp(/0?\./):".",r=String(e).replace(a,"").length;return parseFloat((t?100*e:e/100).toPrecision(r))};var b=a(16);let h;!function(e){e.COUNT="count",e.AVERAGE="avg",e.SUM="sum",e.MIN="min",e.MAX="max",e.RATE="rate",e.CARDINALITY="cardinality",e.P95="p95",e.P99="p99"}(h||(h={}));var y=a(23);const E={...u.builtInComparators,[y.a.OUTSIDE_RANGE]:{text:s.i18n.translate("xpack.infra.metrics.alertFlyout.outsideRangeLabel",{defaultMessage:"Is not between"}),value:y.a.OUTSIDE_RANGE,requiredValues:2}},x=Object(b.euiStyled)(l.EuiFlexGroup)`
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  margin: 0 -4px;
`,v=b.euiStyled.div`
  padding: 0 4px;
`,O=Object(b.euiStyled)(l.EuiHealth)`
  margin-left: 4px;
`,T=e=>{var t,a;const[c,d]=Object(n.useState)(!0),m=Object(n.useCallback)((()=>d(!c)),[c]),{children:p,setAlertParams:g,expression:b,errors:E,expressionId:T,remove:M,fields:F,canDelete:C}=e,{aggType:w=h.MAX,metric:S,comparator:A=y.a.GT,threshold:B=[],warningThreshold:L=[],warningComparator:I}=b,[R,z]=Object(n.useState)(Boolean(null==L?void 0:L.length)),P=Object(n.useMemo)((()=>Boolean(S&&S.endsWith(".pct"))),[S]),D=Object(n.useCallback)((e=>{g(T,{...b,aggType:e,metric:"count"===e?void 0:b.metric})}),[T,b,g]),N=Object(n.useCallback)((e=>{g(T,{...b,metric:e})}),[T,b,g]),G=Object(n.useCallback)((e=>{g(T,{...b,comparator:e})}),[T,b,g]),U=Object(n.useCallback)((e=>{g(T,{...b,warningComparator:e})}),[T,b,g]),Q=Object(n.useCallback)((e=>P?e.map((e=>(e=>f(e,!1))(e))):e),[P]),$=Object(n.useCallback)((e=>{const t=Q(e);t.join()!==b.threshold.join()&&g(T,{...b,threshold:t})}),[T,b,Q,g]),W=Object(n.useCallback)((e=>{var t;const a=Q(e);a.join()!==(null===(t=b.warningThreshold)||void 0===t?void 0:t.join())&&g(T,{...b,warningThreshold:a})}),[T,b,Q,g]),q=Object(n.useCallback)((()=>{R?(z(!1),g(T,Object(r.omit)(b,"warningComparator","warningThreshold"))):(z(!0),g(T,{...b,warningComparator:A,warningThreshold:[]}))}),[R,z,g,A,b,T]),_=i.a.createElement(j,{comparator:A,threshold:B,updateComparator:G,updateThreshold:$,errors:null!==(t=E.critical)&&void 0!==t?t:{},isMetricPct:P}),H=R&&i.a.createElement(j,{comparator:I||A,threshold:L,updateComparator:U,updateThreshold:W,errors:null!==(a=E.warning)&&void 0!==a?a:{},isMetricPct:P});return i.a.createElement(i.a.Fragment,null,i.a.createElement(l.EuiFlexGroup,{gutterSize:"xs"},i.a.createElement(l.EuiFlexItem,{grow:!1},i.a.createElement(l.EuiButtonIcon,{iconType:c?"arrowDown":"arrowRight",onClick:m,"aria-label":s.i18n.translate("xpack.infra.metrics.alertFlyout.expandRowLabel",{defaultMessage:"Expand row."})})),i.a.createElement(l.EuiFlexItem,{grow:!0},i.a.createElement(x,null,i.a.createElement(v,null,i.a.createElement(u.WhenExpression,{customAggTypesOptions:k,aggType:w,onChangeSelectedAggType:D})),"count"!==w&&i.a.createElement(v,null,i.a.createElement(u.OfExpression,{customAggTypesOptions:k,aggField:S,fields:F.map((e=>({normalizedType:e.type,name:e.name}))),aggType:w,errors:E,onChangeSelectedAggField:N,helpText:i.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.ofExpression.helpTextDetail",defaultMessage:"Can't find a metric? {documentationLink}.",values:{documentationLink:i.a.createElement(l.EuiLink,{href:"https://www.elastic.co/guide/en/observability/current/configure-settings.html",target:"BLANK"},i.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.ofExpression.popoverLinkLabel",defaultMessage:"Learn how to add more data"}))}}),"data-test-subj":"ofExpression"})),!R&&_),R&&i.a.createElement(i.a.Fragment,null,i.a.createElement(x,null,_,i.a.createElement(O,{color:"danger"},i.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.criticalThreshold",defaultMessage:"Alert"}))),i.a.createElement(x,null,H,i.a.createElement(O,{color:"warning"},i.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.warningThreshold",defaultMessage:"Warning"})),i.a.createElement(l.EuiButtonIcon,{"aria-label":s.i18n.translate("xpack.infra.metrics.alertFlyout.removeWarningThreshold",{defaultMessage:"Remove warningThreshold"}),iconSize:"s",color:"subdued",iconType:"crossInACircleFilled",onClick:q}))),!R&&i.a.createElement(i.a.Fragment,null," ",i.a.createElement(l.EuiSpacer,{size:"xs"}),i.a.createElement(x,null,i.a.createElement(l.EuiButtonEmpty,{color:"primary",flush:"left",size:"xs",iconType:"plusInCircleFilled",onClick:q},i.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.addWarningThreshold",defaultMessage:"Add warning threshold"}))))),C&&i.a.createElement(l.EuiFlexItem,{grow:!1},i.a.createElement(l.EuiButtonIcon,{"aria-label":s.i18n.translate("xpack.infra.metrics.alertFlyout.removeCondition",{defaultMessage:"Remove condition"}),color:"danger",iconType:"trash",onClick:()=>M(T)}))),c?i.a.createElement("div",{style:{padding:"0 0 0 28px"}},p):null,i.a.createElement(l.EuiSpacer,{size:"s"}))},j=({updateComparator:e,updateThreshold:t,threshold:a,isMetricPct:r,comparator:o,errors:s})=>{const c=Object(n.useMemo)((()=>r?a.map((e=>(e=>f(e,!0))(e))):a),[a,r]);return i.a.createElement(i.a.Fragment,null,i.a.createElement(v,null,i.a.createElement(u.ThresholdExpression,{thresholdComparator:o||y.a.GT,threshold:c,customComparators:E,onChangeSelectedThresholdComparator:e,onChangeSelectedThreshold:t,errors:s})),r&&i.a.createElement("div",{style:{alignSelf:"center"}},i.a.createElement(l.EuiText,{size:"s"},"%")))},k={avg:{text:s.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.avg",{defaultMessage:"Average"}),fieldRequired:!0,validNormalizedTypes:["number"],value:h.AVERAGE},max:{text:s.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.max",{defaultMessage:"Max"}),fieldRequired:!0,validNormalizedTypes:["number","date"],value:h.MAX},min:{text:s.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.min",{defaultMessage:"Min"}),fieldRequired:!0,validNormalizedTypes:["number","date"],value:h.MIN},cardinality:{text:s.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.cardinality",{defaultMessage:"Cardinality"}),fieldRequired:!1,value:h.CARDINALITY,validNormalizedTypes:["number"]},rate:{text:s.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.rate",{defaultMessage:"Rate"}),fieldRequired:!1,value:h.RATE,validNormalizedTypes:["number"]},count:{text:s.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.count",{defaultMessage:"Document count"}),fieldRequired:!1,value:h.COUNT,validNormalizedTypes:["number"]},sum:{text:s.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.sum",{defaultMessage:"Sum"}),fieldRequired:!1,value:h.SUM,validNormalizedTypes:["number"]},p95:{text:s.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.p95",{defaultMessage:"95th Percentile"}),fieldRequired:!1,value:h.P95,validNormalizedTypes:["number"]},p99:{text:s.i18n.translate("xpack.infra.metrics.alertFlyout.aggregationText.p99",{defaultMessage:"99th Percentile"}),fieldRequired:!1,value:h.P99,validNormalizedTypes:["number"]}};var M=a(65),F=a(89),C=a(118),w=a(94),S=a(130),A=a(119),B=a(176);var L=a(148),I=a(19),R=a(131),z=a(177);const P=({expression:e,derivedIndexPattern:t,source:a,filterQuery:s,groupBy:c})=>{var u,d;const{loading:m,data:p}=((e,t,a,r,i)=>{const{timeSize:l,timeUnit:o}=e||{timeSize:1,timeUnit:"m"},s=Object(n.useMemo)((()=>({limit:1,forceInterval:!0,dropLastBucket:!1,groupBy:i,filterQuery:r,metrics:[{field:e.metric,aggregation:e.aggType}],aggregation:e.aggType||"avg"})),[e.aggType,e.metric,r,i]),c=Object(n.useMemo)((()=>({interval:`>=${l||1}${o}`,from:`now-${20*(l||1)}${o}`,to:"now"})),[l,o]);return Object(B.a)(s,null==a?void 0:a.configuration,t,c,null,null)})(e,t,a,s,c),{uiSettings:g}=Object(I.b)().services,f={field:e.metric,aggregation:e.aggType,color:F.a.color0},b=(null==g?void 0:g.get("theme:darkMode"))||!1,h=Object(n.useMemo)((()=>{var e,t;const a=Object(r.first)(null==p?void 0:p.series),n=null===(e=Object(r.first)(null==a?void 0:a.rows))||void 0===e?void 0:e.timestamp,i=null===(t=Object(r.last)(null==a?void 0:a.rows))||void 0===t?void 0:t.timestamp;return null==n||null==i?e=>`${e}`:Object(M.niceTimeFormatter)([n,i])}),[null==p?void 0:p.series]),y=Object(n.useCallback)(Object(S.a)(f),[e]);if(m||!p)return i.a.createElement(R.c,null);const E=e.threshold.slice().sort(),x=null!==(u=null===(d=e.warningThreshold)||void 0===d?void 0:d.slice().sort())&&void 0!==u?u:[],v=[...E,...x].sort(),O=Object(r.first)(p.series);if(!O||!O.rows||0===O.rows.length)return i.a.createElement(R.e,null);const T={...O,rows:O.rows.map((e=>{const t={...e};return v.forEach(((e,a)=>{t[Object(L.a)(f,`threshold_${a}`)]=e})),t}))},j=Object(r.first)(O.rows).timestamp,k=Object(r.last)(O.rows).timestamp,P=Object(A.a)(T,[f],!1),D={max:1.1*Math.max(P.max,Object(r.last)(v)||P.max),min:.9*Math.min(P.min,Object(r.first)(v)||P.min)};D.min===Object(r.first)(e.threshold)&&(D.min=.9*D.min);const{timeSize:N,timeUnit:G}=e,U=R.f[G];return i.a.createElement(i.a.Fragment,null,i.a.createElement(R.a,null,i.a.createElement(M.Chart,null,i.a.createElement(C.a,{type:w.b.bar,metric:f,id:"0",series:T,stack:!1}),i.a.createElement(z.a,{comparator:e.comparator,threshold:e.threshold,sortedThresholds:E,color:F.a.color1,id:"critical",firstTimestamp:j,lastTimestamp:k,domain:D}),e.warningComparator&&e.warningThreshold&&i.a.createElement(z.a,{comparator:e.warningComparator,threshold:e.warningThreshold,sortedThresholds:x,color:F.a.color5,id:"warning",firstTimestamp:j,lastTimestamp:k,domain:D}),i.a.createElement(M.Axis,{id:"timestamp",position:M.Position.Bottom,showOverlappingTicks:!0,tickFormat:h}),i.a.createElement(M.Axis,{id:"values",position:M.Position.Left,tickFormat:y,domain:D}),i.a.createElement(M.Settings,{tooltip:R.i,theme:Object(R.g)(b)}))),i.a.createElement("div",{style:{textAlign:"center"}},"ALL"!==T.id?i.a.createElement(l.EuiText,{size:"xs",color:"subdued"},i.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alerts.dataTimeRangeLabelWithGrouping",defaultMessage:"Last {lookback} {timeLabel} of data for {id}",values:{id:T.id,timeLabel:U,lookback:20*N}})):i.a.createElement(l.EuiText,{size:"xs",color:"subdued"},i.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alerts.dataTimeRangeLabel",defaultMessage:"Last {lookback} {timeLabel}",values:{timeLabel:U,lookback:20*N}}))))},D={aggType:c.a.AVERAGE,comparator:c.b.GT,threshold:[],timeSize:1,timeUnit:"m"},N=e=>{const{setAlertParams:t,alertParams:a,errors:f,metadata:b}=e,{http:h,notifications:y,docLinks:E}=Object(I.b)().services,{source:x,createDerivedIndexPattern:v}=Object(p.a)({sourceId:"default",fetch:h.fetch,toastWarning:y.toasts.addWarning}),[O,j]=Object(n.useState)(1),[k,M]=Object(n.useState)("m"),F=Object(n.useMemo)((()=>v()),[v]),C=Object(n.useMemo)((()=>{var e;return null!=b&&null!==(e=b.currentOptions)&&void 0!==e&&e.metrics?b.currentOptions:{metrics:[],aggregation:"avg"}}),[b]),w=Object(n.useCallback)(((e,r)=>{const n=a.criteria?a.criteria.slice():[];n[e]=r,t("criteria",n)}),[t,a.criteria]),S=Object(n.useCallback)((()=>{var e;const r=(null===(e=a.criteria)||void 0===e?void 0:e.slice())||[];r.push({...D,timeSize:null!=O?O:D.timeSize,timeUnit:null!=k?k:D.timeUnit}),t("criteria",r)}),[t,a.criteria,O,k]),A=Object(n.useCallback)((e=>{var r;const n=(null===(r=a.criteria)||void 0===r?void 0:r.slice())||[];n.length>1&&(n.splice(e,1),t("criteria",n))}),[t,a.criteria]),B=Object(n.useCallback)((e=>{t("filterQueryText",e);try{t("filterQuery",Object(g.a)(e,F,!1)||"")}catch(e){t("filterQuery",c.e)}}),[t,F]),L=Object(n.useCallback)(Object(r.debounce)(B,500),[B]),R=Object(n.useCallback)((e=>{t("groupBy",e&&e.length?e:"")}),[t]),z=Object(n.useMemo)((()=>({aggField:[],timeSizeUnit:[],timeWindowSize:[]})),[]),N=Object(n.useCallback)((e=>{var r;const n=(null===(r=a.criteria)||void 0===r?void 0:r.map((t=>({...t,timeSize:e}))))||[];j(e||void 0),t("criteria",n)}),[a.criteria,t]),G=Object(n.useCallback)((e=>{var r;const n=(null===(r=a.criteria)||void 0===r?void 0:r.map((t=>({...t,timeUnit:e}))))||[];M(e),t("criteria",n)}),[a.criteria,t]),U=Object(n.useCallback)((()=>{var e,a;const r=b;null!=r&&null!==(e=r.currentOptions)&&void 0!==e&&null!==(a=e.metrics)&&void 0!==a&&a.length?t("criteria",r.currentOptions.metrics.map((e=>({metric:e.field,comparator:c.b.GT,threshold:[],timeSize:O,timeUnit:k,aggType:e.aggregation})))):t("criteria",[D])}),[b,t,O,k]),Q=Object(n.useCallback)((()=>{var e,a;const r=b;if(r&&null!==(e=r.currentOptions)&&void 0!==e&&e.filterQuery)t("filterQueryText",r.currentOptions.filterQuery),t("filterQuery",Object(g.a)(r.currentOptions.filterQuery,F)||"");else if(r&&null!==(a=r.currentOptions)&&void 0!==a&&a.groupBy&&r.series){const{groupBy:e}=r.currentOptions,a=Array.isArray(e)?e.map(((e,t)=>{var a,n;return`${e}: "${null===(a=r.series)||void 0===a||null===(n=a.keys)||void 0===n?void 0:n[t]}"`})).join(" and "):`${e}: "${r.series.id}"`;t("filterQueryText",a),t("filterQuery",Object(g.a)(a,F)||"")}}),[b,F,t]),$=Object(n.useCallback)((()=>{var e;const a=b;a&&null!==(e=a.currentOptions)&&void 0!==e&&e.groupBy&&!a.series&&t("groupBy",a.currentOptions.groupBy)}),[b,t]);Object(n.useEffect)((()=>{a.criteria&&a.criteria.length?(j(a.criteria[0].timeSize),M(a.criteria[0].timeUnit)):U(),a.filterQuery||Q(),a.groupBy||$(),a.sourceId||t("sourceId",(null==x?void 0:x.id)||"default"),void 0===a.alertOnNoData&&t("alertOnNoData",!0),void 0===a.alertOnGroupDisappear&&t("alertOnGroupDisappear",!0)}),[b,x]);const W=Object(n.useCallback)((e=>B(e.target.value)),[B]),q=Object(n.useMemo)((()=>{var e;return null===(e=a.criteria)||void 0===e?void 0:e.every((e=>e.aggType===c.a.RATE))}),[a.criteria]),_=Object(n.useMemo)((()=>a.groupBy&&a.groupBy.length>0),[a.groupBy]),H=Object(n.useMemo)((()=>{if(!a.groupBy)return null;return(Array.isArray(a.groupBy)?a.groupBy:[a.groupBy]).map((e=>({groupName:e,pattern:new RegExp(`{"match(_phrase)?":{"${e}":"(.*?)"}}`)})))}),[a.groupBy]),V=Object(n.useMemo)((()=>{const{filterQuery:e}=a;return"string"==typeof e&&H?H.map((({groupName:t,pattern:a})=>{if(a.test(e))return t})).filter((e=>"string"==typeof e)):[]}),[a,H]);return i.a.createElement(i.a.Fragment,null,i.a.createElement(l.EuiSpacer,{size:"m"}),i.a.createElement(l.EuiText,{size:"xs"},i.a.createElement("h4",null,i.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.conditions",defaultMessage:"Conditions"}))),i.a.createElement(l.EuiSpacer,{size:"xs"}),a.criteria&&a.criteria.map(((e,t)=>i.a.createElement(T,{canDelete:a.criteria&&a.criteria.length>1||!1,fields:F.fields,remove:A,addExpression:S,key:t,expressionId:t,setAlertParams:w,errors:f[t]||z,expression:e||{}},i.a.createElement(P,{expression:e,derivedIndexPattern:F,source:x,filterQuery:a.filterQueryText,groupBy:a.groupBy})))),i.a.createElement("div",{style:{marginLeft:28}},i.a.createElement(u.ForLastExpression,{timeWindowSize:O,timeWindowUnit:k,errors:z,onChangeWindowSize:N,onChangeWindowUnit:G})),i.a.createElement(l.EuiSpacer,{size:"m"}),i.a.createElement("div",null,i.a.createElement(l.EuiButtonEmpty,{color:"primary",iconSide:"left",flush:"left",iconType:"plusInCircleFilled",onClick:S},i.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.addCondition",defaultMessage:"Add condition"}))),i.a.createElement(l.EuiSpacer,{size:"m"}),i.a.createElement(l.EuiAccordion,{id:"advanced-options-accordion",buttonContent:s.i18n.translate("xpack.infra.metrics.alertFlyout.advancedOptions",{defaultMessage:"Advanced options"})},i.a.createElement(l.EuiPanel,{color:"subdued"},i.a.createElement(l.EuiCheckbox,{id:"metrics-alert-no-data-toggle",label:i.a.createElement(i.a.Fragment,null,s.i18n.translate("xpack.infra.metrics.alertFlyout.alertOnNoData",{defaultMessage:"Alert me if there's no data"})," ",i.a.createElement(l.EuiToolTip,{content:s.i18n.translate("xpack.infra.metrics.alertFlyout.noDataHelpText",{defaultMessage:"Enable this to trigger the action if the metric(s) do not report any data over the expected time period, or if the alert fails to query Elasticsearch"})},i.a.createElement(l.EuiIcon,{type:"questionInCircle",color:"subdued"}))),checked:a.alertOnNoData,onChange:e=>t("alertOnNoData",e.target.checked)}),i.a.createElement(l.EuiCheckbox,{id:"metrics-alert-partial-buckets-toggle",label:i.a.createElement(i.a.Fragment,null,s.i18n.translate("xpack.infra.metrics.alertFlyout.shouldDropPartialBuckets",{defaultMessage:"Drop partial buckets when evaluating data"})," ",i.a.createElement(l.EuiToolTip,{content:s.i18n.translate("xpack.infra.metrics.alertFlyout.dropPartialBucketsHelpText",{defaultMessage:"Enable this to drop the most recent bucket of evaluation data if it's less than {timeSize}{timeUnit}.",values:{timeSize:O,timeUnit:k}})},i.a.createElement(l.EuiIcon,{type:"questionInCircle",color:"subdued"}))),checked:q||a.shouldDropPartialBuckets,disabled:q,onChange:e=>t("shouldDropPartialBuckets",e.target.checked)}))),i.a.createElement(l.EuiSpacer,{size:"m"}),i.a.createElement(l.EuiFormRow,{label:s.i18n.translate("xpack.infra.metrics.alertFlyout.filterLabel",{defaultMessage:"Filter (optional)"}),helpText:s.i18n.translate("xpack.infra.metrics.alertFlyout.filterHelpText",{defaultMessage:"Use a KQL expression to limit the scope of your alert trigger."}),fullWidth:!0,display:"rowCompressed"},b&&i.a.createElement(d.a,{derivedIndexPattern:F,onChange:L,onSubmit:B,value:a.filterQueryText})||i.a.createElement(l.EuiFieldSearch,{onChange:W,value:a.filterQueryText,fullWidth:!0})),i.a.createElement(l.EuiSpacer,{size:"m"}),i.a.createElement(l.EuiFormRow,{label:s.i18n.translate("xpack.infra.metrics.alertFlyout.createAlertPerText",{defaultMessage:"Group alerts by (optional)"}),helpText:s.i18n.translate("xpack.infra.metrics.alertFlyout.createAlertPerHelpText",{defaultMessage:'Create an alert for every unique value. For example: "host.id" or "cloud.region".'}),fullWidth:!0,display:"rowCompressed"},i.a.createElement(m.a,{onChange:R,fields:F.fields,options:{...C,groupBy:a.groupBy||void 0},errorOptions:V})),V.length>0&&i.a.createElement(i.a.Fragment,null,i.a.createElement(l.EuiSpacer,{size:"s"}),i.a.createElement(l.EuiText,{size:"xs",color:"danger"},i.a.createElement(o.FormattedMessage,{id:"xpack.infra.metrics.alertFlyout.alertPerRedundantFilterError",defaultMessage:"This rule may alert on {matchedGroups} less than expected, because the filter query contains a match for {groupCount, plural, one {this field} other {these fields}}. For more information, refer to {filteringAndGroupingLink}.",values:{matchedGroups:i.a.createElement("strong",null,V.join(", ")),groupCount:V.length,filteringAndGroupingLink:i.a.createElement(l.EuiLink,{href:`${E.links.observability.metricsThreshold}#filtering-and-grouping`},s.i18n.translate("xpack.infra.metrics.alertFlyout.alertPerRedundantFilterError.docsLink",{defaultMessage:"the docs"}))}}))),i.a.createElement(l.EuiSpacer,{size:"s"}),i.a.createElement(l.EuiCheckbox,{id:"metrics-alert-group-disappear-toggle",label:i.a.createElement(i.a.Fragment,null,s.i18n.translate("xpack.infra.metrics.alertFlyout.alertOnGroupDisappear",{defaultMessage:"Alert me if a group stops reporting data"})," ",i.a.createElement(l.EuiToolTip,{content:s.i18n.translate("xpack.infra.metrics.alertFlyout.groupDisappearHelpText",{defaultMessage:"Enable this to trigger the action if a previously detected group begins to report no results. This is not recommended for dynamically scaling infrastructures that may rapidly start and stop nodes automatically."})},i.a.createElement(l.EuiIcon,{type:"questionInCircle",color:"subdued"}))),disabled:!_,checked:Boolean(_&&a.alertOnGroupDisappear),onChange:e=>t("alertOnGroupDisappear",e.target.checked)}),i.a.createElement(l.EuiSpacer,{size:"m"}))};t.default=N},98:function(e,t,a){"use strict";a.d(t,"a",(function(){return n})),a.d(t,"c",(function(){return l})),a.d(t,"d",(function(){return c})),a.d(t,"b",(function(){return p})),a.d(t,"e",(function(){return x}));var r=a(0);const n=["avg","max","min","cardinality","rate","count","sum","p95","p99"],i=n.reduce(((e,t)=>({...e,[t]:null})),{}),l=r.keyof(i),o=r.type({aggregation:l}),s=r.partial({field:r.union([r.string,r[void 0]])}),c=r.intersection([o,s]),u=r.type({field:r.string,from:r.number,to:r.number,interval:r.string}),d=r.type({timerange:u,indexPattern:r.string,metrics:r.array(c)}),m=r.union([r.string,r.null,r[void 0]]),p=r.record(r.string,r.union([r.string,r.null])),g=r.partial({groupBy:r.union([m,r.array(m)]),afterKey:r.union([r.string,r.null,r[void 0],p]),limit:r.union([r.number,r.null,r[void 0]]),filterQuery:r.union([r.string,r.null,r[void 0]]),forceInterval:r.boolean,dropLastBucket:r.boolean}),f=(r.intersection([d,g]),r.type({total:r.number,afterKey:r.union([r.string,r.null,p])})),b=r.keyof({date:null,number:null,string:null}),h=r.type({name:r.string,type:b}),y=r.intersection([r.type({timestamp:r.number}),r.record(r.string,r.union([r.string,r.number,r.null,r[void 0],r.array(r.object)]))]),E=r.intersection([r.type({id:r.string,columns:r.array(h),rows:r.array(y)}),r.partial({keys:r.array(r.string)})]),x=r.type({series:r.array(E),pageInfo:f})}}]);