/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.stackAlerts_bundle_jsonpfunction=window.stackAlerts_bundle_jsonpfunction||[]).push([[3],{48:function(e,t,n){"use strict";n.r(t),n.d(t,"GeoContainmentAlertTypeExpression",(function(){return T})),n.d(t,"default",(function(){return T}));var a=n(2),s=n.n(a),i=n(9),l=n(11),r=n(0),o=n(12);const d=["geo_point"],c=["geo_shape"];var u=n(3),x=n.n(u),p=n(10);class geo_index_pattern_select_GeoIndexPatternSelect extends a.Component{constructor(...e){super(...e),x()(this,"_isMounted",!1),x()(this,"state",{doesIndexPatternHaveGeoField:!1,noIndexPatternsExist:!1}),x()(this,"_loadIndexPattern",(async e=>{if(!e||0===e.length||!this.props.indexPatternService)return;let t;try{t=await this.props.indexPatternService.get(e)}catch(e){return}return this._isMounted&&t.id===e?(this.setState({doesIndexPatternHaveGeoField:t.fields.some((e=>this.props.includedGeoTypes.includes(e.type)))}),t):void 0})),x()(this,"_onIndexPatternSelect",(async e=>{const t=await this._loadIndexPattern(e);t&&this.props.onChange(t)})),x()(this,"_onNoIndexPatterns",(()=>{this.setState({noIndexPatternsExist:!0})}))}componentWillUnmount(){this._isMounted=!1}componentDidMount(){this._isMounted=!0,this.props.value&&this._loadIndexPattern(this.props.value)}_renderNoIndexPatternWarning(){return this.state.noIndexPatternsExist?Object(p.jsx)(s.a.Fragment,null,Object(p.jsx)(i.EuiCallOut,{title:r.i18n.translate("xpack.stackAlerts.geoContainment.noIndexPattern.messageTitle",{defaultMessage:"Couldn't find any index patterns"}),color:"warning"},Object(p.jsx)("p",null,Object(p.jsx)(l.FormattedMessage,{id:"xpack.stackAlerts.geoContainment.noIndexPattern.doThisPrefixDescription",defaultMessage:"You'll need to "}),Object(p.jsx)(i.EuiLink,{href:this.props.http.basePath.prepend("/app/management/kibana/indexPatterns")},Object(p.jsx)(l.FormattedMessage,{id:"xpack.stackAlerts.geoContainment.noIndexPattern.doThisLinkTextDescription",defaultMessage:"Create an index pattern."}))),Object(p.jsx)("p",null,Object(p.jsx)(l.FormattedMessage,{id:"xpack.stackAlerts.geoContainment.noIndexPattern.hintDescription",defaultMessage:"Don't have any data? "}),Object(p.jsx)(i.EuiLink,{href:this.props.http.basePath.prepend("/app/home#/tutorial_directory/sampleData")},Object(p.jsx)(l.FormattedMessage,{id:"xpack.stackAlerts.geoContainment.noIndexPattern.getStartedLinkText",defaultMessage:"Get started with some sample data sets."})))),Object(p.jsx)(i.EuiSpacer,{size:"s"})):null}render(){const e=this.props.IndexPatternSelectComponent,t=!!this.props.value&&!this.state.doesIndexPatternHaveGeoField,n=t?r.i18n.translate("xpack.stackAlerts.geoContainment.noGeoFieldInIndexPattern.message",{defaultMessage:"Index pattern does not contain any allowed geospatial fields. Must have one of type {geoFields}.",values:{geoFields:this.props.includedGeoTypes.join(", ")}}):"";return Object(p.jsx)(s.a.Fragment,null,this._renderNoIndexPatternWarning(),Object(p.jsx)(i.EuiFormRow,{label:r.i18n.translate("xpack.stackAlerts.geoContainment.indexPatternSelectLabel",{defaultMessage:"Index pattern"}),isInvalid:t,error:n},e?Object(p.jsx)(e,{isInvalid:t,isDisabled:this.state.noIndexPatternsExist,indexPatternId:this.props.value,onChange:this._onIndexPatternSelect,placeholder:r.i18n.translate("xpack.stackAlerts.geoContainment.indexPatternSelectPlaceholder",{defaultMessage:"Select index pattern"}),fieldTypes:this.props.includedGeoTypes,onNoIndexPatterns:this._onNoIndexPatterns,isClearable:!1}):Object(p.jsx)("div",null)))}}var b=n(13),j=n.n(b);function g(e){return e?e.map((e=>({value:e,label:e.name}))).sort(((e,t)=>e.label.toLowerCase().localeCompare(t.label.toLowerCase()))):[]}function m({placeholder:e,value:t,onChange:n,fields:a}){const s=[];if(t&&a){const e=a.find((e=>e.name===t));e&&s.push({value:e,label:t})}return Object(p.jsx)(i.EuiComboBox,{singleSelection:!0,options:g(a),selectedOptions:s,onChange:e=>{n(j.a.get(e,"0.value.name"))},isDisabled:!a,renderOption:function(e,t,n){return Object(p.jsx)(i.EuiFlexGroup,{className:n,gutterSize:"s",alignItems:"center"},Object(p.jsx)(i.EuiFlexItem,{grow:null},Object(p.jsx)(o.FieldIcon,{type:e.value.type,fill:"none"})),Object(p.jsx)(i.EuiFlexItem,null,Object(p.jsx)(i.EuiHighlight,{search:t},e.label)))},isClearable:!1,placeholder:e,compressed:!0})}const f=({popoverContent:e,expressionDescription:t,defaultValue:n,value:s,isInvalid:l})=>{const[o,d]=Object(a.useState)(!1);return Object(p.jsx)(i.EuiPopover,{id:"popoverForExpression",button:Object(p.jsx)(i.EuiExpression,{display:"columns","data-test-subj":"selectIndexExpression",description:t,value:s||n,isActive:o,onClick:()=>d(!0),isInvalid:l}),isOpen:o,closePopover:()=>d(!1),ownFocus:!0,anchorPosition:"downLeft",zIndex:8e3,display:"block"},Object(p.jsx)("div",{style:{width:"450px"}},Object(p.jsx)(i.EuiPopoverTitle,null,Object(p.jsx)(i.EuiFlexGroup,{alignItems:"center",gutterSize:"s"},Object(p.jsx)(i.EuiFlexItem,null,t),Object(p.jsx)(i.EuiFlexItem,{grow:!1},Object(p.jsx)(i.EuiButtonIcon,{"data-test-subj":"closePopover",iconType:"cross",color:"danger","aria-label":r.i18n.translate("xpack.stackAlerts.geoContainment.ui.expressionPopover.closePopoverLabel",{defaultMessage:"Close"}),onClick:()=>d(!1)})))),e))},y=({setAlertParamsDate:e,setAlertParamsGeoField:t,errors:n,setIndexPattern:s,indexPattern:c,isInvalid:u,dateField:x,geoField:b,data:j})=>{const{http:g}=Object(o.useKibana)().services,y=j.ui&&j.ui.IndexPatternSelect||null,h=(e=>{const t=Object(a.useRef)();return Object(a.useEffect)((()=>{t.current=e})),t.current})(c),F=Object(a.useRef)({dateFields:[],geoFields:[]});Object(a.useEffect)((()=>{h!==c&&(F.current.geoFields=c.fields.length&&c.fields.filter((e=>d.includes(e.type)))||[],F.current.geoFields.length&&t(F.current.geoFields[0].name),F.current.dateFields=c.fields.length&&c.fields.filter((e=>"date"===e.type))||[],F.current.dateFields.length&&e(F.current.dateFields[0].name))}),[c,h,e,t]);const O=Object(p.jsx)(a.Fragment,null,Object(p.jsx)(i.EuiFormRow,{id:"geoIndexPatternSelect",fullWidth:!0,error:n.index},Object(p.jsx)(geo_index_pattern_select_GeoIndexPatternSelect,{onChange:e=>{e&&s(e)},value:c.id,IndexPatternSelectComponent:y,indexPatternService:j.indexPatterns,http:g,includedGeoTypes:d})),Object(p.jsx)(i.EuiFormRow,{id:"containmentTimeField",fullWidth:!0,label:Object(p.jsx)(l.FormattedMessage,{id:"xpack.stackAlerts.geoContainment.timeFieldLabel",defaultMessage:"Time field"})},Object(p.jsx)(m,{placeholder:r.i18n.translate("xpack.stackAlerts.geoContainment.selectTimeLabel",{defaultMessage:"Select time field"}),value:x,onChange:t=>t&&e(t),fields:F.current.dateFields})),Object(p.jsx)(i.EuiFormRow,{id:"geoField",fullWidth:!0,label:r.i18n.translate("xpack.stackAlerts.geoContainment.geofieldLabel",{defaultMessage:"Geospatial field"})},Object(p.jsx)(m,{placeholder:r.i18n.translate("xpack.stackAlerts.geoContainment.selectGeoLabel",{defaultMessage:"Select geo field"}),value:b,onChange:e=>e&&t(e),fields:F.current.geoFields})));return Object(p.jsx)(f,{isInvalid:u,value:c.title,defaultValue:r.i18n.translate("xpack.stackAlerts.geoContainment.entityIndexSelect",{defaultMessage:"Select an index pattern and geo point field"}),popoverContent:O,expressionDescription:r.i18n.translate("xpack.stackAlerts.geoContainment.entityIndexLabel",{defaultMessage:"index"})})},h=["string","number","ip"];const F=({errors:e,entity:t,setAlertParamsEntity:n,indexFields:s,isInvalid:l})=>{const o=(e=>{const t=Object(a.useRef)();return Object(a.useEffect)((()=>{t.current=e})),t.current})(s),d=Object(a.useRef)({indexFields:[]});Object(a.useEffect)((()=>{j.a.isEqual(o,s)||(d.current.indexFields=function(e){return e.filter((e=>{const t=h.includes(e.type),n=e.name.startsWith("_"),a=!!e.aggregatable;return t&&a&&!n}))}(s),!t&&d.current.indexFields.length&&n(d.current.indexFields[0].name))}),[s,o,n,t]);const c=Object(p.jsx)(i.EuiFormRow,{id:"entitySelect",fullWidth:!0,error:e.index},Object(p.jsx)(m,{placeholder:r.i18n.translate("xpack.stackAlerts.geoContainment.topHitsSplitFieldSelectPlaceholder",{defaultMessage:"Select entity field"}),value:t,onChange:e=>e&&n(e),fields:d.current.indexFields}));return Object(p.jsx)(f,{isInvalid:l,value:t,defaultValue:"Select entity field",popoverContent:c,expressionDescription:r.i18n.translate("xpack.stackAlerts.geoContainment.entityByLabel",{defaultMessage:"by"})})},O=({alertParams:e,errors:t,boundaryIndexPattern:n,boundaryNameField:s,setBoundaryIndexPattern:l,setBoundaryGeoField:d,setBoundaryNameField:u,data:x})=>{const b=["string","number","ip"],{http:j}=Object(o.useKibana)().services,g=x.ui&&x.ui.IndexPatternSelect||null,{boundaryGeoField:y}=e,h={name:"<nothing selected>",type:"string"},F=(e=>{const t=Object(a.useRef)();return Object(a.useEffect)((()=>{t.current=e})),t.current})(n),O=Object(a.useRef)({geoFields:[],boundaryNameFields:[]});Object(a.useEffect)((()=>{F!==n&&(O.current.geoFields=n.fields.length&&n.fields.filter((e=>c.includes(e.type)))||[],O.current.geoFields.length&&d(O.current.geoFields[0].name),O.current.boundaryNameFields=[...n.fields.filter((e=>b.includes(e.type)&&!e.name.startsWith("_")&&!e.name.endsWith("keyword"))),h],O.current.boundaryNameFields.length&&u(O.current.boundaryNameFields[0].name))}),[b,n,h,F,d,u]);const I=Object(p.jsx)(a.Fragment,null,Object(p.jsx)(i.EuiFormRow,{id:"geoIndexPatternSelect",fullWidth:!0,error:t.index},Object(p.jsx)(geo_index_pattern_select_GeoIndexPatternSelect,{onChange:e=>{e&&l(e)},value:n.id,IndexPatternSelectComponent:g,indexPatternService:x.indexPatterns,http:j,includedGeoTypes:c})),Object(p.jsx)(i.EuiFormRow,{id:"geoField",fullWidth:!0,label:r.i18n.translate("xpack.stackAlerts.geoContainment.geofieldLabel",{defaultMessage:"Geospatial field"})},Object(p.jsx)(m,{placeholder:r.i18n.translate("xpack.stackAlerts.geoContainment.selectLabel",{defaultMessage:"Select geo field"}),value:y,onChange:d,fields:O.current.geoFields})),Object(p.jsx)(i.EuiFormRow,{id:"boundaryNameFieldSelect",fullWidth:!0,label:r.i18n.translate("xpack.stackAlerts.geoContainment.boundaryNameSelectLabel",{defaultMessage:"Human-readable boundary name (optional)"})},Object(p.jsx)(m,{placeholder:r.i18n.translate("xpack.stackAlerts.geoContainment.boundaryNameSelect",{defaultMessage:"Select boundary name"}),value:s||null,onChange:e=>{u(e===h.name?void 0:e)},fields:O.current.boundaryNameFields})));return Object(p.jsx)(f,{defaultValue:"Select an index pattern and geo shape field",value:n.title,popoverContent:I,expressionDescription:r.i18n.translate("xpack.stackAlerts.geoContainment.indexLabel",{defaultMessage:"index"})})};var I=n(14);const P="",v="",k="",E="",S="entireIndex",C="",A="",M="",_="",w="";function G(e){try{"kuery"===e.language?I.esKuery.fromKueryExpression(e.query):I.esQuery.luceneStringToDsl(e.query)}catch(e){return!1}return!0}const T=({alertParams:e,alertInterval:t,setAlertParams:n,setAlertProperty:s,errors:o,data:d})=>{const{index:c,indexId:u,indexQuery:x,geoField:b,entity:j,dateField:g,boundaryType:m,boundaryIndexTitle:f,boundaryIndexId:h,boundaryIndexQuery:T,boundaryGeoField:N,boundaryNameField:L}=e,[D,R]=Object(a.useState)({id:"",fields:[],title:""}),z=e=>{e&&(R(e),e.title&&n("index",e.title),e.id&&n("indexId",e.id))},[W,B]=Object(a.useState)(x||{query:"",language:"kuery"}),[q,Q]=Object(a.useState)({id:"",fields:[],title:""}),H=e=>{e&&(Q(e),e.title&&n("boundaryIndexTitle",e.title),e.id&&n("boundaryIndexId",e.id))},[V,K]=Object(a.useState)(T||{query:"",language:"kuery"});r.i18n.translate("xpack.stackAlerts.geoContainment.fixErrorInExpressionBelowValidationMessage",{defaultMessage:"Expression contains errors."});return Object(a.useEffect)((()=>{(async()=>{if(s("params",{...e,index:null!=c?c:v,indexId:null!=u?u:k,entity:null!=j?j:P,dateField:null!=g?g:E,boundaryType:null!=m?m:S,geoField:null!=b?b:C,boundaryIndexTitle:null!=f?f:A,boundaryIndexId:null!=h?h:M,boundaryGeoField:null!=N?N:_,boundaryNameField:null!=L?L:w}),d.indexPatterns){if(u){const e=await d.indexPatterns.get(u);z(e)}if(h){const e=await d.indexPatterns.get(h);H(e)}}})()}),[]),Object(p.jsx)(a.Fragment,null,null,Object(p.jsx)(i.EuiSpacer,{size:"l"}),Object(p.jsx)(i.EuiTitle,{size:"xs"},Object(p.jsx)("h5",null,Object(p.jsx)(l.FormattedMessage,{id:"xpack.stackAlerts.geoContainment.selectEntity",defaultMessage:"Select entity"}))),Object(p.jsx)(i.EuiSpacer,{size:"s"}),Object(p.jsx)(y,{dateField:g,geoField:b,errors:o,setAlertParamsDate:e=>n("dateField",e),setAlertParamsGeoField:e=>n("geoField",e),setAlertProperty:s,setIndexPattern:z,indexPattern:D,isInvalid:!u||!g||!b,data:d}),Object(p.jsx)(F,{errors:o,entity:j,setAlertParamsEntity:e=>n("entity",e),indexFields:D.fields,isInvalid:!!(u&&g&&b)&&!j}),Object(p.jsx)(i.EuiSpacer,{size:"s"}),Object(p.jsx)(i.EuiFlexItem,null,Object(p.jsx)(I.QueryStringInput,{disableAutoFocus:!0,bubbleSubmitEvent:!0,indexPatterns:D?[D]:[],query:W,onChange:e=>{e.language&&(G(e)&&n("indexQuery",e),B(e))}})),Object(p.jsx)(i.EuiSpacer,{size:"l"}),Object(p.jsx)(i.EuiTitle,{size:"xs"},Object(p.jsx)("h5",null,Object(p.jsx)(l.FormattedMessage,{id:"xpack.stackAlerts.geoContainment.selectBoundaryIndex",defaultMessage:"Select boundary"}))),Object(p.jsx)(i.EuiSpacer,{size:"s"}),Object(p.jsx)(O,{alertParams:e,errors:o,boundaryIndexPattern:q,setBoundaryIndexPattern:H,setBoundaryGeoField:e=>e&&n("boundaryGeoField",e),setBoundaryNameField:e=>n("boundaryNameField",e||""),boundaryNameField:L,data:d}),Object(p.jsx)(i.EuiSpacer,{size:"s"}),Object(p.jsx)(i.EuiFlexItem,null,Object(p.jsx)(I.QueryStringInput,{disableAutoFocus:!0,bubbleSubmitEvent:!0,indexPatterns:q?[q]:[],query:V,onChange:e=>{e.language&&(G(e)&&n("boundaryIndexQuery",e),K(e))}})),Object(p.jsx)(i.EuiSpacer,{size:"l"}))}}}]);